<script>
  class LoginManager {
    constructor() {
      this.init();
    }

    init() {
      this.setupEventListeners();
      this.checkExistingToken();
    }

    setupEventListeners() {
      const loginForm = document.getElementById("loginForm");
      if (loginForm) {
        loginForm.addEventListener("submit", (e) => this.handleLogin(e));
      }

      const roleSelect = document.getElementById("role");
      if (roleSelect) {
        roleSelect.addEventListener("change", (e) => this.handleRoleChange(e));
      }
    }

    async handleLogin(e) {
      e.preventDefault();

      const formData = new FormData(e.target);
      const loginData = {
        email: formData.get("email"),
        password: formData.get("password"),
        role: formData.get("role"),
      };

      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;

      try {
        // Show loading state
        submitBtn.innerHTML =
          '<span class="spinner-border spinner-border-sm" role="status"></span> Logging in...';
        submitBtn.disabled = true;

        const response = await fetch("/api/auth/login", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(loginData),
        });

        const data = await response.json();

        if (data.status === "success") {
          // Store token in localStorage
          localStorage.setItem("smartTiffinToken", data.token);
          localStorage.setItem("userData", JSON.stringify(data.data.user));

          this.showAlert("Login successful! Redirecting...", "success");

          // Redirect based on role
          setTimeout(() => {
            this.redirectToDashboard(data.data.user.role);
          }, 1000);
        } else {
          this.showAlert(data.message, "error");
        }
      } catch (error) {
        console.error("Login error:", error);
        this.showAlert("Login failed. Please try again.", "error");
      } finally {
        // Reset button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    }

    handleRoleChange(e) {
      const role = e.target.value;
      // You can add role-specific UI changes here
      console.log("Role changed to:", role);
    }

    redirectToDashboard(role) {
      const dashboards = {
        admin: "/admin-dashboard.html",
        chef: "/chef-dashboard.html",
        customer: "/customer-dashboard.html",
      };

      window.location.href = dashboards[role] || "/";
    }

    checkExistingToken() {
      const token = localStorage.getItem("smartTiffinToken");
      if (token) {
        // Verify token is still valid
        fetch("/api/auth/me", {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        })
          .then((response) => {
            if (response.ok) {
              return response.json();
            }
            throw new Error("Token invalid");
          })
          .then((data) => {
            // Redirect to appropriate dashboard
            this.redirectToDashboard(data.data.user.role);
          })
          .catch((error) => {
            // Clear invalid token
            localStorage.removeItem("smartTiffinToken");
            localStorage.removeItem("userData");
          });
      }
    }

    showAlert(message, type) {
      // Remove existing alerts
      const existingAlert = document.querySelector(".alert");
      if (existingAlert) existingAlert.remove();

      const alertDiv = document.createElement("div");
      alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
      alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

      const form = document.getElementById("loginForm");
      form.appendChild(alertDiv);
    }
  }

  // Initialize when DOM is loaded
  document.addEventListener("DOMContentLoaded", () => {
    new LoginManager();
  });
</script>
